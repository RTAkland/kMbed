# KMbed

KMbed is a suite of integrated plugins and libraries that offers a Java-like resource system for Kotlin/Native.  
It supports resource streaming, zlib based compression, and it is integrated with kotlinx.io out of the box!

### How to use it

Using KMbed is as simple as applying the KMbed Gradle Plugin!  
This will automatically apply the KMbed Kotlin Compiler plugin, as well as the KMbed runtime and all of its dependencies.

```
plugins {
    id("coming-soon") version "<version>"
}
```

### How it works

KMbed works by utilizing the CInterop provided by Kotlin/Native.  

Since the Gradle plugin knows about all resources that will be included in the finished
binary at configure-time, it can generate a C-header for every resource which contains (an optionally compressed)
octet stream of the associated resource file in form of an unsigned byte array.

This array is forced into the read-only data section of the resulting binary using the
`__attribute__((section(".data")))` compiler attribute, which forces the linker used by
the CInterop MinGW toolchain to place the data contained within the array in the corresponding
section in the linked binary.
The generated headers are then added to a new CInterop task for the corresponding target.  

At this point, the Kotlin compiler plugin will instrument an existing stub function in the runtime
to initialize and add all generated resources to the global resource lookup, using compile-time information
to compute the ID of each resource and avoid runtime computations later on.
The data is passed to the Resource objects as a `COpaquePointer` (`void*`) alongside their respective sizes.
The first few bytes of each resource array are also generated by the compiler plugin and indicate whether the 
following resource data is compressed or not.

The resource(s) can then be retrieved at any time using `Resource.get(...)` providing the ID of the resource.